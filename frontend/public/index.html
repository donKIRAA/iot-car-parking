<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Parking San Carlos</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        :root {
            --slot-width: 50px;
            --bg-color: #f4f4f9;
            --wall-color: #9ca3af;
            --wall-border: #4b5563;
            --slot-border: #374151;
            --free-color: #86efac;   /* Verde */
            --busy-color: #fca5a5;   /* Rojo */
            --error-color: #f59e0b;  /* √Åmbar (Fallo) */
            --text-color: #1f2937;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            width: 100%;
            max-width: 1100px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 30px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        h1 { font-size: 1.5rem; text-transform: uppercase; font-weight: 700; }

        /* --- LEYENDA --- */
        .legend { display: flex; gap: 20px; font-size: 0.9rem; align-items: center; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        
        .dot { width: 15px; height: 15px; border-radius: 3px; border: 1px solid #999; }
        .dot.free { background-color: var(--free-color); }
        .dot.busy { background-color: var(--busy-color); }
        .dot.error { background-color: var(--error-color); animation: pulse-error 2s infinite; }
        .dot.wall { background-color: var(--wall-color); opacity: 0.6; background-image: linear-gradient(45deg, #bbb 25%, transparent 25%, transparent 50%, #bbb 50%, #bbb 75%, transparent 75%, transparent); background-size: 10px 10px;}

        /* --- BOT√ìN HISTORIAL --- */
        .btn-history {
            background-color: #374151;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }
        .btn-history:hover { background-color: #1f2937; }

        @keyframes pulse-error {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        /* --- CONTENEDOR MAPA --- */
        .blueprint-container {
            background: white;
            padding: 40px;
            border: 3px solid #000;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            width: fit-content;
        }

        .parking-grid {
            display: grid;
            grid-template-columns: repeat(20, var(--slot-width));
            grid-template-rows: repeat(19, var(--slot-width)); 
            gap: 2px;
        }

        .slot, .structure, .entrance {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* ESTRUCTURAS */
        .structure {
            background-color: var(--wall-color);
            border: 1px solid var(--wall-border);
            background-image: linear-gradient(45deg, #6b7280 25%, transparent 25%, transparent 50%, #6b7280 50%, #6b7280 75%, transparent 75%, transparent);
            background-size: 10px 10px; 
            opacity: 0.5;
        }

        /* COCHERAS */
        .slot {
            border: 2px solid var(--slot-border);
            background-color: white;
            flex-direction: column;
            color: #333;
            z-index: 2;
            transition: background-color 0.3s;
        }
        .slot.libre { background-color: var(--free-color); }
        .slot.ocupado { background-color: var(--busy-color); }
        
        /* ESTADO DE FALLO */
        .slot.fallo {
            background-color: var(--error-color);
            color: white;
            border-color: #b45309;
            animation: pulse-error 2s infinite;
        }
        .slot.fallo .car-icon { display: none; }
        .slot.fallo::after { content: "‚ö†Ô∏è"; font-size: 1.5rem; }

        .car-icon {
            width: 28px;
            height: 28px;
            fill: #374151;
            opacity: 0.1;
            transition: opacity 0.3s;
        }
        .slot.ocupado .car-icon { opacity: 1; }

        /* --- MAPPING GEOM√âTRICO --- */
        .structure.corner-square { grid-area: 1 / 5 / 3 / 7; }
        .structure.corner-square-bottom { grid-area: 9 / 18 / 11 / 20; }
        .structure.middle-fill { grid-area: 11 / 12 / 14 / 15; }

        /* Zona Superior */
        #slot-21 { grid-area: 1 / 7 / 3 / 8; } 
        #slot-22 { grid-area: 1 / 8 / 3 / 9; }
        #slot-23 { grid-area: 1 / 9 / 3 / 10; }
        #slot-24 { grid-area: 1 / 10 / 3 / 11; }
        #slot-25 { grid-area: 1 / 11 / 3 / 12; }
        #slot-26 { grid-area: 1 / 12 / 3 / 13; }
        #slot-27 { grid-area: 1 / 13 / 3 / 14; }
        #slot-28 { grid-area: 1 / 14 / 3 / 15; }
        #slot-29 { grid-area: 1 / 15 / 3 / 16; }
        #slot-30 { grid-area: 1 / 16 / 3 / 17; }
        #slot-31 { grid-area: 1 / 17 / 3 / 18; } 
        .structure.tr { grid-area: 1 / 18 / 3 / 20; } 

        /* Columna Derecha */
        #slot-32 { grid-area: 3 / 18 / 4 / 20; }
        #slot-33 { grid-area: 4 / 18 / 5 / 20; }
        #slot-34 { grid-area: 5 / 18 / 6 / 20; }
        #slot-35 { grid-area: 6 / 18 / 7 / 20; }
        #slot-36 { grid-area: 7 / 18 / 8 / 20; } 
        #slot-37 { grid-area: 8 / 18 / 9 / 20; } 

        /* Fila Intermedia */
        #slot-38 { grid-area: 9 / 17 / 11 / 18; }
        #slot-39 { grid-area: 9 / 16 / 11 / 17; }
        #slot-40 { grid-area: 9 / 15 / 11 / 16; } 
        #slot-41 { grid-area: 9 / 14 / 11 / 15; } 
        #slot-42 { grid-area: 9 / 13 / 11 / 14; }
        #slot-43 { grid-area: 9 / 12 / 11 / 13; } 

        /* Columna Izquierda */
        #slot-20 { grid-area: 3 / 5 / 4 / 7; }
        #slot-19 { grid-area: 4 / 5 / 5 / 7; }
        #slot-18 { grid-area: 5 / 5 / 6 / 7; }
        #slot-17 { grid-area: 6 / 5 / 7 / 7; }
        #slot-16 { grid-area: 7 / 5 / 8 / 7; }
        #slot-15 { grid-area: 8 / 5 / 9 / 7; }
        #slot-14 { grid-area: 9 / 5 / 10 / 7; }
        #slot-13 { grid-area: 10 / 5 / 11 / 7; }

        /* Zona Inferior */
        #slot-9  { grid-area: 11 / 3 / 13 / 4; }
        #slot-10 { grid-area: 11 / 4 / 13 / 5; }
        #slot-11 { grid-area: 11 / 5 / 13 / 6; }
        #slot-12 { grid-area: 11 / 6 / 13 / 7; }
        .structure.bl { grid-area: 11 / 1 / 13 / 3; } 
        #slot-8 { grid-area: 13 / 1 / 14 / 3; }
        #slot-7 { grid-area: 14 / 1 / 15 / 3; }

        /* Fila Inferior */
        #slot-6 { grid-area: 15 / 3 / 17 / 4; }
        #slot-5 { grid-area: 15 / 4 / 17 / 5; }
        #slot-4 { grid-area: 15 / 5 / 17 / 6; }
        #slot-3 { grid-area: 15 / 6 / 17 / 7; }
        #slot-2 { grid-area: 15 / 7 / 17 / 8; }
        #slot-1 { grid-area: 15 / 8 / 17 / 9; }
        .structure.corner-fill { grid-area: 15 / 1 / 17 / 3; }

        /* Entrada */
        .entrance { grid-area: 17 / 9 / 19 / 13; border-top: 2px dashed #333; text-align: center; display: flex; align-items: center; justify-content: center; }

        /* Plazas 44-46 */
        #slot-44 { grid-area: 14 / 13 / 15 / 15; } 
        #slot-45 { grid-area: 15 / 13 / 16 / 15; }
        #slot-46 { grid-area: 16 / 13 / 17 / 15; }

        /* --- ALERTAS FLOTANTES --- */
        .alert-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            max-width: 350px;
        }
        .alert-box {
            background: white;
            border-left: 5px solid var(--error-color);
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            animation: slideIn 0.3s ease-out;
        }
        .alert-content { font-size: 0.9rem; color: #333; }
        .alert-close { background: none; border: none; font-weight: bold; color: #999; cursor: pointer; margin-left: 10px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- PANEL HISTORIAL --- */
        .history-panel {
            position: fixed;
            top: 0; right: -300px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 2000;
        }
        .history-panel.open { right: 0; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .history-list { list-style: none; }
        .history-item { padding: 10px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; display: flex; justify-content: space-between; }
        .history-time { color: #888; font-size: 0.8rem; }
        .history-badge { background: var(--error-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }

    </style>
</head>
<body>

    <header>
        <div>
            <h1>SYSTEM CAR PARKING SAN CARLOS</h1>
        </div>
        <div class="legend">
            <div class="legend-item"><div class="dot free"></div> Libre (<span id="free-count">-</span>)</div>
            <div class="legend-item"><div class="dot busy"></div> Ocupado (<span id="busy-count">-</span>)</div>
            <div class="legend-item"><div class="dot error"></div> Alerta (<span id="error-count">0</span>)</div>
            <button class="btn-history" onclick="toggleHistory()">üìã Historial</button>
        </div>
    </header>

    <div id="history-panel" class="history-panel">
        <div class="history-header">
            <h3>Historial de Fallos</h3>
            <button class="alert-close" onclick="toggleHistory()">‚úï</button>
        </div>
        <ul id="history-list" class="history-list">
            <li style="color:#999; text-align:center;">Sin registros recientes</li>
        </ul>
    </div>

    <div class="blueprint-container">
        <div class="parking-grid" id="grid-container">
            
            <div class="structure corner-square"></div>
            <div class="structure corner-square-bottom"></div>
            <div class="structure middle-fill"></div>

            <div class="structure tr"></div>
            <div class="structure bl"></div>
            <div class="structure corner-fill"></div>
            
            <div class="entrance">INGRESO ‚¨Ü</div>
            
        </div>
    </div>

    <div id="alert-system" class="alert-container"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const gridContainer = document.getElementById('grid-container');
        const alertSystem = document.getElementById('alert-system');
        const historyList = document.getElementById('history-list');
        const carSvg = `<svg class="car-icon" viewBox="0 0 24 24"><path d="M18.92 6c-.2-.58-.76-1-1.42-1h-11c-.66 0-1.22.42-1.42 1L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-6zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`;

        // --- MODIFICACI√ìN 1: ESTADO INICIAL = FALLO ---
        for (let i = 1; i <= 46; i++) {
            const div = document.createElement('div');
            // Al crearse, nacen en estado 'fallo' hasta que Firebase diga lo contrario
            div.className = 'slot fallo'; 
            div.id = `slot-${i}`;
            div.innerHTML = `${carSvg}<span>${i}</span>`;
            gridContainer.appendChild(div);
        }

        database.ref('parking_slots').on('value', (snapshot) => {
            const data = snapshot.val() || {}; 
            updateUI(data);
        });

        let activeAlerts = new Set();
        let historyLog = [];

        function updateUI(data) {
            let free = 0, busy = 0, failures = 0;
            
            for (let i = 1; i <= 46; i++) {
                const slotEl = document.getElementById(`slot-${i}`);
                
                // --- MODIFICACI√ìN 2: L√ìGICA POR DEFECTO ---
                // Si NO hay datos en Firebase para la plaza i, asumimos FALLO.
                let status = 'fallo'; 
                
                const slotData = data[i] || data[i.toString()];
                
                // Solo si Firebase tiene datos, cambiamos a libre/ocupado
                if (slotData && slotData.status) {
                    status = slotData.status.toLowerCase();
                }

                slotEl.className = `slot ${status}`;

                if (status === 'ocupado') busy++;
                else if (status === 'libre') free++;
                else if (status === 'fallo') {
                    failures++;
                    // Mantenemos tu l√≥gica de alertas:
                    // Si la plaza es 'fallo' y no ten√≠a alerta previa, se genera.
                    // OJO: Esto generar√° alertas para las plazas que no tienen sensor.
                    // Si te molesta que salgan 42 alertas, podr√≠as filtrar aqu√≠, 
                    // pero lo dejo como pediste para que sea escalable.
                    if (!activeAlerts.has(i)) {
                        // Opcional: Puedes comentar estas 2 l√≠neas si no quieres que el historial se llene de las plazas vac√≠as
                        // showAlert(i, "Fallo de Sensor / Sin Datos");
                        // addToHistory(i, "Sin conexi√≥n");
                        
                        activeAlerts.add(i);
                    }
                } else {
                    if (activeAlerts.has(i)) {
                        closeAlertAutomatically(i);
                        activeAlerts.delete(i);
                    }
                }
            }
            
            document.getElementById('free-count').textContent = free;
            document.getElementById('busy-count').textContent = busy;
            document.getElementById('error-count').textContent = failures;
        }

        function showAlert(slotId, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-box';
            alertDiv.id = `alert-box-${slotId}`;
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <strong>‚ö†Ô∏è Alerta: Plaza ${slotId}</strong><br>
                    ${message}
                </div>
                <button class="alert-close" onclick="removeAlert(${slotId})">‚úï</button>
            `;
            alertSystem.appendChild(alertDiv);
        }

        function addToHistory(slotId, cause) {
            const time = new Date().toLocaleTimeString();
            if (historyLog.length === 0) historyList.innerHTML = '';
            
            historyLog.push({ id: slotId, time: time });

            const item = document.createElement('li');
            item.className = 'history-item';
            item.innerHTML = `
                <span><span class="history-badge">P${slotId}</span> ${cause}</span>
                <span class="history-time">${time}</span>
            `;
            historyList.insertBefore(item, historyList.firstChild);
        }

        function toggleHistory() {
            document.getElementById('history-panel').classList.toggle('open');
        }

        window.removeAlert = function(slotId) {
            const el = document.getElementById(`alert-box-${slotId}`);
            if (el) el.remove();
        };

        function closeAlertAutomatically(slotId) {
            const el = document.getElementById(`alert-box-${slotId}`);
            if (el) {
                el.style.opacity = '0.5';
                setTimeout(() => { if(el) el.remove(); }, 1000);
            }
        }
    </script>
</body>
</html>